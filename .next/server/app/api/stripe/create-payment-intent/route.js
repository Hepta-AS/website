"use strict";(()=>{var e={};e.id=5798,e.ids=[5798],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},56877:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>S,originalPathname:()=>h,patchFetch:()=>f,requestAsyncStorage:()=>g,routeModule:()=>d,serverHooks:()=>_,staticGenerationAsyncStorage:()=>I,staticGenerationBailout:()=>y});var o={};r.r(o),r.d(o,{POST:()=>m});var i=r(95419),n=r(69108),s=r(99678),a=r(78070),c=r(55919),l=r(32455),u=r(15922);async function p(e,t,r){console.log("--- DEBUG API Route: getOrCreateStripeCustomerId ---"),console.log(`Fetching/Creating Stripe customer for Supabase User ID: ${e}, Email: ${t}`);let o=(0,c.createRouteHandlerClient)({cookies:l.cookies}),{data:i,error:n}=await o.from("profiles").select("stripe_customer_id").eq("user_id",e).single();if(n&&"PGRST116"!==n.code)throw console.error("API Route: Error fetching profile in getOrCreateStripeCustomerId:",n),Error(`Failed to fetch profile: ${n.message}`);if(i?.stripe_customer_id)return console.log("API Route: Found existing Stripe Customer ID in profile:",i.stripe_customer_id),i.stripe_customer_id;if(console.log("API Route: No Stripe Customer ID in profile, creating new Stripe customer."),!t)throw console.error("API Route: Email is required to create a new Stripe customer."),Error("Email is required to create a new Stripe customer if one doesn't exist.");if(!u.Ag)throw console.error("API Route: Stripe instance is not initialized."),Error("Stripe is not configured properly.");let s=await u.Ag.customers.create({email:t,name:r,metadata:{supabaseUUID:e}});if(!s||!s.id)throw console.error("API Route: Failed to create Stripe customer via lib/stripe.ts or ID missing:",s),Error("Stripe customer creation failed or ID missing from Stripe response.");console.log("API Route: New Stripe customer created. ID:",s.id);let{error:a}=await o.from("profiles").upsert({user_id:e,stripe_customer_id:s.id,updated_at:new Date().toISOString()},{onConflict:"user_id"});if(a)throw console.error("API Route: Error upserting profile with new Stripe Customer ID:",a),Error(`Failed to save Stripe Customer ID to profile: ${a.message}`);return console.log("API Route: Profile upserted with new Stripe Customer ID:",s.id),s.id}async function m(e){console.log("\n--- DEBUG API Route: /api/stripe/create-payment-intent ---");try{let{amount:t,currency:r="nok"}=await e.json();if(console.log("API Route: Request body parsed:",{amount:t,currency:r}),"number"!=typeof t||t<=0)return console.warn("API Route: Invalid amount received:",t),a.Z.json({error:"Amount is required and must be a positive number"},{status:400});let o=(0,c.createRouteHandlerClient)({cookies:l.cookies});console.log("API Route: Supabase client created.");let{data:{session:i},error:n}=await o.auth.getSession();if(n)return console.error("API Route: Error getting session:",n),a.Z.json({error:"Failed to get session"},{status:500});if(!i)return console.warn("API Route: No active session. Unauthorized."),a.Z.json({error:"Unauthorized"},{status:401});console.log("API Route: Session retrieved. User ID:",i.user.id);let s=i.user,m=null;try{if(console.log(`API Route: Attempting to get or create customer ID for Supabase user: ${s.id}`),m=await p(s.id,s.email||void 0,s.user_metadata?.full_name||void 0),console.log(`API Route: Stripe Customer ID from getOrCreateStripeCustomerId: ${m}`),!m)throw Error("getOrCreateStripeCustomerId returned null, indicating failure to obtain a customer ID.")}catch(e){return console.error("API Route: Error from getOrCreateStripeCustomerId:",e),a.Z.json({error:`Failed to get or create Stripe customer: ${e.message}`},{status:500})}console.log(`API Route: Calling lib/stripe createPaymentIntent with amount: ${t}, currency: ${r}, customerId: ${m}`);let d=await (0,u.Gl)(t,r,m);if(console.log("API Route: PaymentIntent object received from lib/stripe:",JSON.stringify(d,null,2)),"error"in d)return console.error(`API Route: Error creating Payment Intent. Message: ${d.message}`),a.Z.json({error:`Failed to create payment intent: ${d.message}`},{status:500});if(!d.client_secret)return console.error("API Route: PaymentIntent created but client_secret is missing"),a.Z.json({error:"PaymentIntent client_secret missing from Stripe response"},{status:500});return console.log("API Route: Successfully created Payment Intent. Returning client_secret to frontend:",d.client_secret.substring(0,20)+"..."),a.Z.json({clientSecret:d.client_secret})}catch(t){console.error("API Route: Unhandled error in create-payment-intent endpoint:",t);let e=t.message||"Unknown server error";if("AuthApiError"===t.name||"AuthRetryableFetchError"===t.name)return a.Z.json({error:`Authentication error: ${e}`},{status:401});return a.Z.json({error:`Failed to create payment intent: ${e}`},{status:500})}}let d=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/stripe/create-payment-intent/route",pathname:"/api/stripe/create-payment-intent",filename:"route",bundlePath:"app/api/stripe/create-payment-intent/route"},resolvedPagePath:"/Users/alexanderamundsen/hepta/hepta-3/app/api/stripe/create-payment-intent/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:I,serverHooks:_,headerHooks:S,staticGenerationBailout:y}=d,h="/api/stripe/create-payment-intent/route";function f(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:I})}},15922:(e,t,r)=>{r.d(t,{Ag:()=>i,Ce:()=>u,Gl:()=>c,Z$:()=>l,a7:()=>p,wK:()=>a,zu:()=>m});var o=r(80782);let i=(()=>{let e="sk_test_51NTj6ECBZbubqLlTavZEEYr8YqLtMwVYfzIY8EyT3kXY2yuSv6z7hsiQ2omjZnQ1TMIFee3emq7HIcMAe4rWdAoc00CZhpLtEf";if(console.log("\n--- DEBUG: lib/stripe.ts -> getStripeInstance ---"),console.log("NODE_ENV:","production"),console.log("Raw STRIPE_SECRET_KEY from env:",e),!e)return console.warn("⚠️ lib/stripe.ts: STRIPE_SECRET_KEY is NOT SET in environment variables. Stripe operations will be mocked or fail."),null;if(e.startsWith("sk_live_"))console.warn("\uD83D\uDD34 lib/stripe.ts: WARNING: Attempting to use a LIVE Stripe key (sk_live_).");else if(e.startsWith("sk_test_"))console.log("✅ lib/stripe.ts: Using a TEST Stripe key (sk_test_). This is good for development.");else{let t=e.length>14?e.substring(0,7)+"..."+e.substring(e.length-4):e;return console.warn(`⚠️ lib/stripe.ts: STRIPE_SECRET_KEY ("${t}") does not look like a valid Stripe secret key (should start with sk_test_ or sk_live_).`),null}try{let t=e.length>14?e.substring(0,7)+"..."+e.substring(e.length-4):e;console.log(`lib/stripe.ts: Attempting to initialize Stripe with API key: ${t}`);let r=new o.Z(e,{apiVersion:"2023-10-16",typescript:!0});return console.log("✅ lib/stripe.ts: Stripe initialized successfully."),r}catch(e){return console.error("❌ lib/stripe.ts: Failed to initialize Stripe with API key. Error:",e),null}})(),n=(e,...t)=>{},s=e=>Math.round(100*e),a=async(e,t,r)=>{if(n("createCustomer - Start",{email:e,name:t,metadata:r}),console.log("--- DEBUG: lib/stripe.ts -> createCustomer ---"),console.log("Is 'stripe' object initialized here?",i?"YES":"NO - Stripe key likely missing/invalid in env!"),!i)return console.warn("⚠️ lib/stripe.ts: Stripe instance is null in createCustomer. Returning MOCK customer."),{id:"cus_mock_STRIPE_NULL_"+Date.now().toString(36)+Math.random().toString(36).substring(2),email:e,name:t,metadata:r,object:"customer",created:Math.floor(Date.now()/1e3),error:!0,message:"Stripe not initialized (null instance), returning mock customer."};try{console.log(`lib/stripe.ts: Attempting REAL Stripe API call: customers.create for email: ${e}`);let o={email:e};t&&(o.name=t),r&&(o.metadata=r);let n=await i.customers.create(o);return console.log("✅ lib/stripe.ts: Stripe customer created successfully via API. ID:",n.id),n}catch(o){return console.error("❌ lib/stripe.ts: Error calling Stripe API (customers.create):",o),{id:"cus_mock_API_ERROR_"+Date.now().toString(36)+Math.random().toString(36).substring(2),email:e,name:t,metadata:r,object:"customer",created:Math.floor(Date.now()/1e3),error:!0,message:o.message||"Unknown error during Stripe API call to create customer"}}},c=async(e,t="nok",r)=>{if(n("createPaymentIntent - Start",{amount:e,currency:t,customerId:r}),console.log("--- DEBUG: lib/stripe.ts -> createPaymentIntent ---"),console.log("Is 'stripe' object initialized here?",i?"YES":"NO - Stripe key likely missing/invalid in env!"),!i){console.warn("⚠️ lib/stripe.ts: Stripe instance is null in createPaymentIntent. Returning MOCK Payment Intent.");let o="pi_mock_secret_STRIPE_NULL_"+Date.now().toString(36)+Math.random().toString(36).substring(2);return{id:"pi_mock_STRIPE_NULL_"+Date.now().toString(36)+Math.random().toString(36).substring(2),amount:s(e),currency:t,client_secret:o,customer:r,status:"requires_payment_method",object:"payment_intent",error:!0,message:"Stripe not initialized (null instance), returning mock payment intent."}}try{console.log(`lib/stripe.ts: Attempting REAL Stripe API call: paymentIntents.create. Amount: ${e}, Currency: ${t}, CustomerID: ${r||"None"}`);let o={amount:s(e),currency:t,automatic_payment_methods:{enabled:!0}};r&&(o.customer=r);let n=await i.paymentIntents.create(o);return console.log("✅ lib/stripe.ts: REAL Stripe Payment Intent created. Client Secret starts with:",n.client_secret?.substring(0,15)+"..."),n}catch(i){console.error("❌ lib/stripe.ts: Error calling Stripe API (paymentIntents.create):",i);let o="pi_mock_secret_API_ERROR_"+Date.now().toString(36)+Math.random().toString(36).substring(2);return{id:"pi_mock_API_ERROR_"+Date.now().toString(36)+Math.random().toString(36).substring(2),amount:s(e),currency:t,client_secret:o,customer:r,status:"requires_payment_method",object:"payment_intent",error:!0,message:i.message||"Unknown error during Stripe API call to create payment intent"}}},l=async(e,t,r,o="nok")=>{if(n("createInvoice - Start",{customerId:e,description:t,amount:r,currency:o}),console.log("--- DEBUG: lib/stripe.ts -> createInvoice --- 'stripe' initialized?",i?"YES":"NO"),!i)return console.warn("⚠️ lib/stripe.ts: Stripe instance is null in createInvoice. Returning MOCK invoice."),{id:"in_mock_STRIPE_NULL_"+Date.now().toString(36),customer:e,amount_due:s(r),currency:o,description:t,status:"open",due_date:Math.floor(Date.now()/1e3)+2592e3,created:Math.floor(Date.now()/1e3),error:!0,message:"Stripe not initialized"};try{console.log(`lib/stripe.ts: Attempting REAL Stripe API call for createInvoice. Customer: ${e}`),await i.invoiceItems.create({customer:e,amount:s(r),currency:o,description:t});let n=await i.invoices.create({customer:e,auto_advance:!0,collection_method:"send_invoice",days_until_due:30}),a=await i.invoices.finalizeInvoice(n.id);return await i.invoices.sendInvoice(a.id),console.log("✅ lib/stripe.ts: REAL Stripe Invoice created and sent. ID:",a.id),a}catch(i){return console.error("❌ lib/stripe.ts: Error creating REAL Stripe invoice:",i),{id:"in_mock_API_ERROR_"+Date.now().toString(36),customer:e,amount_due:s(r),currency:o,description:t,status:"open",due_date:Math.floor(Date.now()/1e3)+2592e3,created:Math.floor(Date.now()/1e3),error:!0,message:i.message||"Unknown API error creating invoice"}}},u=async e=>{if(n("getCustomerInvoices - Start",{customerId:e}),console.log("--- DEBUG: lib/stripe.ts -> getCustomerInvoices --- 'stripe' initialized?",i?"YES":"NO"),!i)return console.warn("⚠️ lib/stripe.ts: Stripe instance is null in getCustomerInvoices. Returning MOCK invoices."),[{id:"in_mock_STRIPE_NULL_cust_inv",customer:e,amount_due:1e4,currency:"nok",status:"open",due_date:Math.floor(Date.now()/1e3)+2592e3,hosted_invoice_url:"#",created:Math.floor(Date.now()/1e3)-86400,error:!0,message:"Stripe not initialized"}];try{console.log(`lib/stripe.ts: Attempting REAL Stripe API call for getCustomerInvoices. Customer: ${e}`);let t=await i.invoices.list({customer:e,limit:100});return console.log(`✅ lib/stripe.ts: Fetched ${t.data.length} REAL Stripe Invoices for customer.`),t.data}catch(t){return console.error("❌ lib/stripe.ts: Error fetching REAL customer invoices:",t),[{id:"in_mock_API_ERROR_cust_inv",customer:e,amount_due:1e4,currency:"nok",status:"open",due_date:Math.floor(Date.now()/1e3)+2592e3,hosted_invoice_url:"#",created:Math.floor(Date.now()/1e3)-86400,error:!0,message:t.message||"Unknown API error fetching invoices"}]}},p=async e=>{if(n("payInvoice - Start",{invoiceId:e}),console.log("--- DEBUG: lib/stripe.ts -> payInvoice --- 'stripe' initialized?",i?"YES":"NO"),!i)return console.warn("⚠️ lib/stripe.ts: Stripe instance is null in payInvoice. Returning MOCK payment status."),{id:e,status:"paid",paid:!0,amount_paid:1e4,currency:"nok",error:!0,message:"Stripe not initialized"};try{console.log(`lib/stripe.ts: Attempting REAL Stripe API call for payInvoice. Invoice ID: ${e}`);let t=await i.invoices.pay(e);return console.log("✅ lib/stripe.ts: REAL Stripe Invoice paid. Status:",t.status),t}catch(t){return console.error("❌ lib/stripe.ts: Error paying REAL Stripe invoice:",t),{id:e,status:"open",paid:!1,error:!0,message:t.message||"Unknown API error paying invoice"}}},m=async e=>{throw n("createTestInvoice - Start",{customerId:e}),console.log("--- DEBUG: lib/stripe.ts -> createTestInvoice --- 'stripe' initialized?",i?"YES":"NO"),console.error("❌ lib/stripe.ts: createTestInvoice called outside development mode."),Error("Test invoices can only be created in development mode")}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[1638,6206,2455,5919,782],()=>r(56877));module.exports=o})();