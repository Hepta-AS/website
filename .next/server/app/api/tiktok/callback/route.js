"use strict";(()=>{var e={};e.id=5137,e.ids=[5137],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},31837:(e,o,r)=>{r.r(o),r.d(o,{headerHooks:()=>p,originalPathname:()=>_,patchFetch:()=>x,requestAsyncStorage:()=>k,routeModule:()=>d,serverHooks:()=>u,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>h});var t={};r.r(t),r.d(t,{GET:()=>l});var n=r(95419),i=r(69108),a=r(99678),s=r(78070),c=r(32455);async function l(e){let o=(0,c.cookies)(),r=o.get("tiktok_auth_state")?.value,t=o.get("tiktok_code_verifier")?.value,n=e.nextUrl.searchParams,i=n.get("code"),a=n.get("state"),l=n.get("error"),d=n.get("error_description");if(console.log("--- DEBUG: /api/tiktok/callback ---"),console.log("Request URL:",e.url),console.log("Code from TikTok:",i),console.log("State from TikTok:",a),console.log("Stored state from cookie:",r),console.log("Stored code_verifier from cookie:",t),console.log("Error from TikTok:",l),console.log("Error description from TikTok:",d),o.delete("tiktok_auth_state"),o.delete("tiktok_code_verifier"),l)return console.error(`Error received from TikTok in callback: ${l} - ${d}`),s.Z.redirect(new URL(`/dashboard?error=${l}&description=${d}`,e.nextUrl.origin));if(!a||a!==r)return console.error("Invalid state parameter or state mismatch. TikTok state:",a,"Cookie state:",r),s.Z.redirect(new URL("/dashboard?error=state_validation_failed",e.nextUrl.origin));if(!i)return console.error("Authorization code not found in callback and no error reported by TikTok."),s.Z.redirect(new URL("/dashboard?error=auth_code_missing",e.nextUrl.origin));if(!t)return console.error("Code verifier not found in cookie."),s.Z.redirect(new URL("/dashboard?error=code_verifier_missing",e.nextUrl.origin));let k=process.env.TIKTOK_CLIENT_ID,g=process.env.TIKTOK_CLIENT_SECRET,u=process.env.TIKTOK_REDIRECT_URI;if(console.log("Client Key for token exchange:",k?"SET":"NOT SET"),console.log("Client Secret for token exchange:",g?"SET":"NOT SET"),console.log("Redirect URI for token exchange:",u),!k||!g||!u)return console.error("TikTok Client ID, Secret, or Redirect URI not configured for token exchange"),s.Z.redirect(new URL("/dashboard?error=server_config_error_token_exchange",e.nextUrl.origin));try{let o=new URLSearchParams({client_key:k,client_secret:g,code:i,grant_type:"authorization_code",redirect_uri:u,code_verifier:t});console.log("Payload for token exchange (body):",o.toString());let r=await fetch("https://open.tiktokapis.com/v2/oauth/token/",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o});if(!r.ok){let o=await r.json();return console.error("TikTok token exchange failed:",o),console.log("TikTok token exchange response status:",r.status),console.log("TikTok token exchange error response body:",JSON.stringify(o,null,2)),s.Z.redirect(new URL(`/dashboard?error=token_exchange_failed&details=${encodeURIComponent(o.error_description||o.error||JSON.stringify(o))}`,e.nextUrl.origin))}let n=await r.json(),{access_token:a,refresh_token:c,expires_in:l,open_id:d,scope:p}=n;console.log("Token data received:",JSON.stringify(n,null,2));let h=n.refresh_expires_in||2592e3,_=s.Z.redirect(new URL("/dashboard",e.nextUrl.origin));return _.cookies.set("tiktok_access_token",a,{httpOnly:!0,secure:!0,sameSite:"lax",path:"/",maxAge:l||3600}),c&&_.cookies.set("tiktok_refresh_token",c,{httpOnly:!0,secure:!0,sameSite:"lax",path:"/",maxAge:h}),_.cookies.set("tiktok_open_id",d,{secure:!0,sameSite:"lax",path:"/",maxAge:h}),_}catch(o){return console.error("Error during TikTok token exchange or cookie setting:",o),s.Z.redirect(new URL("/dashboard?error=internal_server_error_token_exchange",e.nextUrl.origin))}}let d=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/tiktok/callback/route",pathname:"/api/tiktok/callback",filename:"route",bundlePath:"app/api/tiktok/callback/route"},resolvedPagePath:"/Users/alexanderamundsen/hepta/hepta-3/app/api/tiktok/callback/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:k,staticGenerationAsyncStorage:g,serverHooks:u,headerHooks:p,staticGenerationBailout:h}=d,_="/api/tiktok/callback/route";function x(){return(0,a.patchFetch)({serverHooks:u,staticGenerationAsyncStorage:g})}}};var o=require("../../../../webpack-runtime.js");o.C(e);var r=e=>o(o.s=e),t=o.X(0,[1638,6206,2455],()=>r(31837));module.exports=t})();