(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[221],{1674:function(e,t,s){Promise.resolve().then(s.bind(s,6670))},6670:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return b}});var n=s(7437),r=s(2265),a=s(9376),o=s(7648),l=s(6853),i=s(2360),c=s(5863),u=s(5302),d=s(2660),m=s(2869),f=s(6070),g=s(3022),h=s(8730);let x=(0,i.J)("pk_test_51NTj6ECBZbubqLlTkG0te9lkV8yeJ2oICi7xozoKXI6iftnjKhBLOhI28HgOEd4UIk8UGzqsMhXx8A5MQFTEJnXm009dnJfaPI");function p(e){let{amount:t,onSuccess:s,onError:a}=e,o=(0,l.useStripe)(),i=(0,l.useElements)(),[u,d]=(0,r.useState)(!1),[g,h]=(0,r.useState)(null),x=async e=>{if(e.preventDefault(),o&&i){d(!0),h(null);try{let{error:e}=await o.confirmPayment({elements:i,confirmParams:{return_url:"".concat(window.location.origin,"/faktura/betalt")},redirect:"if_required"});e?(h(e.message||"En feil oppstod."),null==a||a(e.message||"En feil oppstod.")):null==s||s()}catch(e){h(e.message||"En feil oppstod."),null==a||a(e.message||"En feil oppstod.")}finally{d(!1)}}};return(0,n.jsxs)("form",{onSubmit:x,className:"bg-white border border-gray-200 rounded-lg shadow-sm",children:[(0,n.jsxs)(f.Ol,{className:"p-6 border-b border-gray-200",children:[(0,n.jsx)(f.ll,{className:"text-lg font-semibold text-gray-900",children:"Fullf\xf8r betaling"}),(0,n.jsxs)(f.SZ,{className:"text-gray-500",children:["Bel\xf8p: ",t.toFixed(2)," NOK"]})]}),(0,n.jsxs)(f.aY,{className:"p-6 space-y-4",children:[(0,n.jsx)(l.PaymentElement,{}),g&&(0,n.jsx)("p",{className:"text-sm text-red-500",children:g})]}),(0,n.jsx)(f.eW,{className:"flex justify-end p-6 border-t border-gray-100",children:(0,n.jsx)(m.z,{type:"submit",disabled:!o||u,className:"bg-blue-600 hover:bg-blue-700",children:u?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(c.Z,{className:"mr-2 h-4 w-4 animate-spin"}),"Behandler..."]}):"Betal n\xe5"})})]})}function S(){var e;let t=(0,a.useRouter)(),s=(0,a.useSearchParams)().get("id"),{sessionToken:i}=(0,h.a)(),[c,m]=(0,r.useState)(null),[S,b]=(0,r.useState)(null),[v,y]=(0,r.useState)(!0),[k,j]=(0,r.useState)(!0),[N,w]=(0,r.useState)(null),[_,T]=(0,r.useState)(!1);return((0,r.useEffect)(()=>{s&&(async()=>{try{m({id:s,number:"INV-2025",amount_due:1249.99,currency:"NOK",description:"Webutvikling"})}catch(e){w("Kunne ikke hente faktura.")}finally{y(!1)}})()},[s]),(0,r.useEffect)(()=>{c&&(async()=>{try{j(!0);let e="pi_1234567890_secret_".concat(Math.random().toString(36).substring(2));b(e)}catch(e){w("Kunne ikke laste betalingsinformasjon.")}finally{j(!1)}})()},[c]),v)?(0,n.jsx)("div",{className:"max-w-3xl mx-auto mt-8",children:(0,n.jsx)(g.O,{className:"h-[400px] w-full rounded-lg"})}):N?(0,n.jsx)("div",{className:"max-w-3xl mx-auto mt-8 text-center text-red-500",children:N}):_?(0,n.jsx)("div",{className:"max-w-3xl mx-auto mt-8",children:(0,n.jsxs)(f.Zb,{className:"border-green-200 bg-green-50",children:[(0,n.jsx)(f.Ol,{children:(0,n.jsxs)(f.ll,{className:"flex items-center gap-2 text-green-700",children:[(0,n.jsx)(u.Z,{className:"h-6 w-6"}),"Betaling fullf\xf8rt"]})}),(0,n.jsx)(f.aY,{children:(0,n.jsx)("p",{className:"text-green-700",children:"Du blir n\xe5 videresendt..."})})]})}):(0,n.jsxs)("div",{className:"max-w-3xl mx-auto space-y-6 mt-8",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)(o.default,{href:"/faktura",className:"text-gray-500 hover:text-gray-800",children:(0,n.jsx)(d.Z,{className:"h-4 w-4"})}),(0,n.jsxs)("h1",{className:"text-2xl font-bold text-gray-900",children:["Faktura #",null==c?void 0:c.number]})]}),(0,n.jsxs)(f.Zb,{className:"border-gray-200 bg-white shadow-sm",children:[(0,n.jsxs)(f.Ol,{children:[(0,n.jsx)(f.ll,{className:"text-xl font-semibold text-gray-900",children:null==c?void 0:c.description}),(0,n.jsxs)(f.SZ,{className:"text-gray-500",children:["Total:"," ",(0,n.jsxs)("span",{className:"font-medium text-gray-800",children:[null==c?void 0:null===(e=c.amount_due)||void 0===e?void 0:e.toFixed(2)," ",null==c?void 0:c.currency]})]})]}),(0,n.jsx)(f.aY,{children:k?(0,n.jsx)(g.O,{className:"h-[300px] w-full rounded-lg"}):S?(0,n.jsx)(l.Elements,{stripe:x,options:{clientSecret:S,appearance:{theme:"stripe",variables:{colorPrimary:"#2563eb",fontFamily:"Inter, sans-serif",borderRadius:"6px"}}},children:(0,n.jsx)(p,{amount:null==c?void 0:c.amount_due,onSuccess:()=>{T(!0),setTimeout(()=>t.push("/faktura/betalt"),2e3)},onError:e=>w(e)})}):(0,n.jsx)("p",{className:"text-center text-red-500",children:"Kunne ikke vise betalingsinformasjon."})})]})]})}function b(){return(0,n.jsx)(r.Suspense,{fallback:(0,n.jsx)("div",{className:"max-w-3xl mx-auto mt-8",children:(0,n.jsx)(g.O,{className:"h-[400px] w-full rounded-lg"})}),children:(0,n.jsx)(S,{})})}},2869:function(e,t,s){"use strict";s.d(t,{z:function(){return c}});var n=s(7437),r=s(2265),a=s(7053),o=s(535),l=s(4508);let i=(0,o.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-blue-600 text-white hover:bg-blue-700",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),c=r.forwardRef((e,t)=>{let{className:s,variant:r,size:o,asChild:c=!1,...u}=e,d=c?a.g7:"button";return(0,n.jsx)(d,{className:(0,l.cn)(i({variant:r,size:o,className:s})),ref:t,...u})});c.displayName="Button"},6070:function(e,t,s){"use strict";s.d(t,{Ol:function(){return l},SZ:function(){return c},Zb:function(){return o},aY:function(){return u},eW:function(){return d},ll:function(){return i}});var n=s(7437),r=s(2265),a=s(4508);let o=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,n.jsx)("div",{ref:t,className:(0,a.cn)("rounded-lg border bg-card text-card-foreground shadow-sm",s),...r})});o.displayName="Card";let l=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,n.jsx)("div",{ref:t,className:(0,a.cn)("flex flex-col space-y-1.5 p-6",s),...r})});l.displayName="CardHeader";let i=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,n.jsx)("div",{ref:t,className:(0,a.cn)("text-2xl font-semibold leading-none tracking-tight",s),...r})});i.displayName="CardTitle";let c=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,n.jsx)("div",{ref:t,className:(0,a.cn)("text-sm text-muted-foreground",s),...r})});c.displayName="CardDescription";let u=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,n.jsx)("div",{ref:t,className:(0,a.cn)("p-6 pt-0",s),...r})});u.displayName="CardContent";let d=r.forwardRef((e,t)=>{let{className:s,...r}=e;return(0,n.jsx)("div",{ref:t,className:(0,a.cn)("flex items-center p-6 pt-0",s),...r})});d.displayName="CardFooter"},3022:function(e,t,s){"use strict";s.d(t,{O:function(){return a}});var n=s(7437),r=s(4508);function a(e){let{className:t,...s}=e;return(0,n.jsx)("div",{className:(0,r.cn)("animate-pulse rounded-md bg-muted",t),...s})}},8730:function(e,t,s){"use strict";s.d(t,{AuthProvider:function(){return m},a:function(){return f}});var n=s(7437),r=s(2265),a=s(5452),o=s(9376),l=s(4508);let i=(0,r.createContext)({user:null,sessionToken:null,userRole:null,login:async()=>{},logout:async()=>{},checkAuth:async()=>({isLoggedIn:!1,user:null}),createTestSession:async()=>{}}),c={id:"test-user-id",email:"test@example.com",user_metadata:{full_name:"Test User"},app_metadata:{},aud:"authenticated",created_at:new Date().toISOString(),role:"admin"},u=()=>"test_"+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),d=e=>{var t;if("undefined"==typeof document)return null;let s="; ".concat(document.cookie).split("; ".concat(e,"="));return 2===s.length&&(null===(t=s.pop())||void 0===t?void 0:t.split(";").shift())||null},m=e=>{let{children:t,serverSession:s=null}=e,[m,f]=(0,r.useState)(null),[g,h]=(0,r.useState)(null),[x,p]=(0,r.useState)(null),[S]=(0,r.useState)(()=>(0,a.createClientComponentClient)()),b=(0,o.useRouter)(),v=(0,r.useRef)(!1),y=(0,r.useCallback)(async e=>{if(!e||!e.email)return null;try{var t;let s=await fetch("/api/stripe/create-customer-for-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e.id,email:e.email,name:(null===(t=e.user_metadata)||void 0===t?void 0:t.full_name)||e.email.split("@")[0]})});if(!s.ok){let e=await s.text();return console.error("Failed to create Stripe customer:",e),null}let{customerId:n}=await s.json();return n}catch(e){return console.error("Error ensuring Stripe customer:",e),null}},[]),k=(0,r.useCallback)(async()=>{console.log("Checking auth state..."),"authenticated"===d("session")&&console.log("Found authenticated session cookie");let e=(0,l.$o)("testSession");if(e)try{return console.log("Found test session:",e),f(e.user),h(e.token),p(e.user.role||"customer"),document.cookie="hasTestSession=true; path=/",{isLoggedIn:!0,user:e.user}}catch(e){console.error("Error parsing test session:",e),(0,l.dZ)("testSession")}let{data:{session:t}}=await S.auth.getSession();if(console.log("Auth session:",t?"Exists":"None"),t){console.log("Setting logged in state to true"),f(t.user),h(t.access_token),document.cookie="session=authenticated; path=/; max-age=".concat(604800,"; SameSite=Strict; Secure");try{let{data:e,error:s}=await S.from("profiles").select("role").eq("id",t.user.id).single();!s&&e?p(e.role||"customer"):p("customer")}catch(e){console.error("Error fetching user role:",e),p("customer")}y(t.user)}else console.log("Setting logged in state to false"),f(null),h(null),p(null),document.cookie="session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Strict; Secure";return{isLoggedIn:!!t,user:(null==t?void 0:t.user)||null}},[S.auth,y]);(0,r.useEffect)(()=>{v.current||(k(),v.current=!0)},[k]),(0,r.useEffect)(()=>{let{data:{subscription:e}}=S.auth.onAuthStateChange(async(e,t)=>{console.log("Auth state changed:",{event:e,session:t}),t?(console.log("Auth state change: User logged in"),f(t.user),h(t.access_token),(0,l.qQ)("sessionToken",t.access_token),document.cookie="session=authenticated; path=/; max-age=".concat(604800,"; SameSite=Strict; Secure")):(0,l.$o)("testSession")||(console.log("Auth state change: User logged out"),f(null),h(null),(0,l.dZ)("sessionToken"),document.cookie="session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Strict; Secure")});return()=>{e.unsubscribe()}},[S.auth]);let j=async()=>{console.log("Creating test session");let e=u(),t={user:{...c,role:"admin"},token:e,created_at:new Date().toISOString()};(0,l.qQ)("testSession",t),(0,l.qQ)("sessionToken",e),document.cookie="hasTestSession=true; path=/; SameSite=Strict; Secure",document.cookie="session=authenticated; path=/; max-age=".concat(604800,"; SameSite=Strict; Secure"),f(c),h(e),p("admin"),console.log("Test session created:",t)},N=async(e,t)=>{console.log("Attempting login with email:",e);try{await new Promise(e=>setTimeout(e,500));let{data:s,error:n}=await S.auth.signInWithPassword({email:e,password:t});if(n)throw console.error("Login error:",n),n;console.log("Login successful:",s.session?"Session exists":"No session"),s.session&&(f(s.session.user),h(s.session.access_token),(0,l.qQ)("sessionToken",s.session.access_token),document.cookie="session=authenticated; path=/; max-age=".concat(604800,"; SameSite=Strict; Secure"),console.log("Auth state updated after login"))}catch(e){throw console.error("Login process error:",e),e}},w=async()=>{(0,l.dZ)("testSession"),(0,l.dZ)("sessionToken"),document.cookie="hasTestSession=false; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Strict; Secure",document.cookie="session=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Strict; Secure",await S.auth.signOut(),f(null),h(null),p(null),b.push("/")};return(0,n.jsx)(i.Provider,{value:{user:m,sessionToken:g,userRole:x,login:N,logout:w,checkAuth:k,createTestSession:j},children:t})},f=()=>{let e=(0,r.useContext)(i);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},4508:function(e,t,s){"use strict";s.d(t,{$o:function(){return o},cn:function(){return a},dZ:function(){return i},qQ:function(){return l}});var n=s(1994),r=s(3335);function a(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return(0,r.m6)((0,n.W)(t))}function o(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;try{let s=localStorage.getItem(e);if(null===s)return t;return JSON.parse(s)}catch(s){return console.error('Error reading localStorage key "'.concat(e,'":'),s),t}}function l(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(t){console.error('Error setting localStorage key "'.concat(e,'":'),t)}}function i(e){try{localStorage.removeItem(e)}catch(t){console.error('Error removing localStorage key "'.concat(e,'":'),t)}}}},function(e){e.O(0,[569,523,451,803,971,117,744],function(){return e(e.s=1674)}),_N_E=e.O()}]);